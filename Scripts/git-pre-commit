#!/usr/bin/env sh

# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

#
# A simple pre commit hook that:
#  - Checks that staged source files are formatted correctly (and re-formats badly formatted files).
#  - Checks that license banner is present.
#  - Checks that UE_INLINE_GENERATED_CPP_BY_NAME is present when required.
#
# It should be installed via:
#
#   > cp Scripts/git-pre-commit .git/hooks/pre-commit
#   > chmod u+x .git/hooks/pre-commit
#

if command -v python3 >/dev/null 2>&1; then
  PY=python3
elif command -v python >/dev/null 2>&1; then
  PY=python
else
  PY=""
fi

if [ -z "$PY" ]; then
  echo "WARN: python not found; skipping python checks" >&2
else
  echo "Running inline-generated include check"
  $PY Scripts/check_inline_generated_cpp_includes.py
  if [ $? -ne 0 ]; then
    echo "Commit aborted: generated-include check failed."
    exit 1
  fi
  echo "Running license banner check"
  $PY Scripts/check_license_banner.py
  if [ $? -ne 0 ]; then
    echo "Commit aborted: license banner check failed."
    exit 1
  fi

  SOURCE_FILES="$(git diff-index --cached --name-only HEAD | grep -E '^.*\.(cpp|h|cs|uplugin|uproject)$' | tr '\n' ' ')"
  if [ -n "$SOURCE_FILES" ]; then
    echo "Running Source Code Formatter on staged source files: $SOURCE_FILES"
    $PY Scripts/format.py --verbose --dry-run $SOURCE_FILES
    if [ $? -ne 0 ]; then
      # shellcheck disable=SC2086
      $PY Scripts/format.py --verbose $SOURCE_FILES
      echo "Commit aborted due to code format inconsistencies. Files re-formatted, please review and update commit as required."
      exit 1
    fi
  fi
fi

exit 0
